<!doctype html>
  <html>
    <head>
      <link rel="stylesheet" href="node_modules/xterm/dist/xterm.css" />
      <script src="node_modules/xterm/dist/xterm.js"></script>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    </head>
    <body>
      <div id="terminal"></div>
      <script>

        var serverAddress = "http://localhost:8000/test.txt";

        createTerminal()

        function createTerminal() {
          var term = new Terminal({cursorBlink: true, cursorStyle: "bar"})
          term.open(document.getElementById('terminal'))
          term.writeln(" Welcome to Private")

          var input = ""
          var saveInput = ""
          var inputHistory = []
          var historyIndex = 0
          var keyIndex = 0
          var post = ""

          var prompt = ' > ';
          term.prompt = function () {
            term.write('\r\n' + prompt)
            input = ""
          };

          term.prompt()

          term.deleteLine = function () {
            while (keyIndex < input.length + 1) {
              // Make sure we're at the end of the line
              term.write('\x1b[C')
              keyIndex += 1
            }
            while (input.length > 0) {
              term.write('\b \b')
              input = input.slice(0, -1)
            }
            keyIndex = 0
          }

// ---------------- Needs to send and receive data via ajax ----------------- //

          term.enter = function () {

            callback()

            // var xhttp = new XMLHttpRequest();
            // xhttp.onreadystatechange = function() {
            //   if (this.readyState == 4 && this.status == 200) {
            //     if (this.responseText.length > 0) {
            //       term.write("\r\n " + this.responseText)
            //     }
            //     if (input != inputHistory[inputHistory.length - 1]) {
            //       // Don't want to save the same command twice
            //       inputHistory.push(input)
            //     }
            //     historyIndex = inputHistory.length
            //     keyIndex = 0
            //     post = ""
            //     term.prompt()
            //   }
            // };
            // xhttp.open("POST", serverAddress, true)
            // xhttp.send(input);

          //   data = {cmd: input}
          //   $.ajax({
          //     type: "POST",
          //     url: "https://private.unforgettable.me/action/12345",
          //     data: data,
          //     success: callback,
          //   });
          }

          callback = function() {
            //term.writeln()
            if (input != inputHistory[inputHistory.length - 1]) {
              // Don't want to save the same command twice
              inputHistory.push(input)
            }
            historyIndex = inputHistory.length
            keyIndex = 0
            post = ""
            term.prompt()
          }

// -------------------------------------------------------------------------- //

          term.on('paste', function (data, ev) {
            pre = input.slice(0, keyIndex)
            pki = keyIndex
            term.deleteLine()
            term.write('\b \b')
            input = pre + data + post
            term.write(input)
            for (var i = 0; i < post.length; i++) {
              term.write('\x1b[D')
            }
            keyIndex = pre.length + data.length
          });

          term.on('click', function (ev) {
            console.log("hello")
          })

          term.on('key', function (key, ev) {
            var printable = (
              !ev.altKey && !ev.altGraphKey && !ev.ctrlKey && !ev.metaKey
            );
            if (ev.key == 'Enter') {
              // enter
              term.enter()
            } else if (ev.key == 'Backspace') {
              // backspace
              if (input.slice(0, keyIndex).length > 0) {
                // So we don't delete the prompt
                term.write('\b \b')
                if (post.length == 0) {
                  input = input.slice(0, -1)
                  post = input.slice(keyIndex)
                } else {
                  pre = input.slice(0, keyIndex - 1)
                  tki = keyIndex

                  // Need to move post back
                  term.deleteLine()
                  keyIndex = tki
                  input = pre + post
                  term.write(input)
                  for (var i = 0; i < post.length; i++) {
                    term.write('\x1b[D')
                  }
                  post = input.slice(keyIndex-1)
                }
                keyIndex -= 1
              }
            } else if (ev.key == 'ArrowLeft') {
              // Left arrow key
              if (keyIndex > 0) {
                keyIndex -= 1
                term.write('\x1b[D')
                post = input.slice(keyIndex)
              }

            } else if (ev.key == 'ArrowRight') {
              // Right arrow key
              if (keyIndex < input.length) {
                keyIndex += 1
                term.write('\x1b[C')
                post = input.slice(keyIndex)
              }
            } else if (ev.key == 'ArrowUp'){
              // Up arrow key - go backwards in input command history
              ev.preventDefault()
              if (historyIndex == inputHistory.length) {
                saveInput = input
              }
              if (historyIndex >= 0 && inputHistory.length > 0) {
                if (historyIndex != 0) {
                  historyIndex -= 1
                }
                term.deleteLine()
                term.write('\b \b')
                input = inputHistory[historyIndex]
                term.write(input)
                keyIndex = input.length
              }
            } else if (ev.key == 'ArrowDown') {
              // Down arrow key - go forwards in input command history
              ev.preventDefault()
              if (historyIndex < inputHistory.length - 1) {
                historyIndex += 1
                term.deleteLine()
                term.write('\b \b')
                input = inputHistory[historyIndex]
                term.write(input)
                keyIndex = input.length
              } else if (historyIndex == inputHistory.length - 1) {
                historyIndex += 1
                term.deleteLine()
                term.write('\b \b')
                input = saveInput
                term.write(input)
                keyIndex = input.length
              }
            } else if (ev.key == 'Tab') {
              // Tab
              ev.preventDefault()
              input += "    "
              term.write("    ")
              keyIndex += 4
            } else if (printable) {
              // regular input
              if (post.length > 0) {
                pre = input.slice(0, keyIndex)
                pki = keyIndex
                term.deleteLine()
                term.write('\b \b')
                input = pre + key + post
                term.write(input)
                for (var i = 0; i < post.length; i++) {
                  term.write('\x1b[D')
                }
                keyIndex = pki
              } else {
                input += key
                term.write(key);
              }
              keyIndex += 1
            }
          });
        }


      </script>
    </body>
  </html>
